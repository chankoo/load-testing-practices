version: '3.8'

services:
  mysql:
    build:
      context: ./db/
    container_name: mysql
    ports:
      - '3306:3306'
    volumes:
      - ./db/mysql-init-files/:/docker-entrypoint-initdb.d/
      - ./db/mysql-confs/:/etc/mysql/conf.d/
      - mysql-storage:/var/lib/mysql
  sample-feed:
    build:
      context: ./sample_feed/
    container_name: sample-feed
    volumes:
      - ./sample_feed:/ltp/sample_feed
    ports:
      - "80:80"
    entrypoint:
      [ "/ltp/sample_feed/docker-entrypoint.sh" ]
    depends_on:
      - mysql
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - '3005:3000'
    depends_on:
      - influxdb
    volumes:
      - grafana-storage:/var/lib/grafana
    user: root
  influxdb:
    image: influxdb:1.8.10-alpine
    platform: linux/amd64
    container_name: influx
    ports:
      - '8086:8086'
    environment:
      - INFLUXDB_ADMIN_ENABLED=true
      - INFLUXDB_ADMIN_USER=admin
      - INFLUXDB_ADMIN_PASSWORD=admin
    tty: true
    stdin_open: true
    volumes:
      - influx-storage:/var/lib/influxdb
  redis:
    image: redis:latest
    container_name: redis
    ports:
      - '6379:6379'
  celery:
    build:
      context: ./sample_feed
      dockerfile: celery.Dockerfile
    container_name: celery
    volumes:
      - ./sample_feed:/ltp/sample_feed
    command: celery -A feed worker --loglevel=info
    depends_on:
      - sample-feed
volumes:
  grafana-storage: {}
  influx-storage: {}
  mysql-storage: {}
